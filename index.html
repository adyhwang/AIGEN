<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四则运算练习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#F59E0B',
                        paper: '#FFFDD0',
                        success: '#10B981',
                        error: '#EF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .dragging {
                cursor: grabbing;
            }
            .resizing {
                cursor: nwse-resize;
            }
            .equation-input {
                width: 60px;
                text-align: center;
                margin: 0 4px;
                padding: 2px 4px;
                border: 1px solid #ccc;
                border-radius: 3px;
            }
            .equation-container {
                margin-bottom: 12px;
                padding: 8px;
                border-radius: 6px;
                background-color: #f9fafb;
                display: flex;
                align-items: center;
                flex-wrap: wrap;
            }
            .result-icon {
                margin-left: 10px;
                font-weight: bold;
            }
            #notepad-container {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
            }
            .notepad-btn {
                @apply p-2 hover:bg-gray-200 rounded transition-all;
            }
            .notepad-btn-mobile {
                @apply md:p-2 p-3; /* 移动端增大按钮尺寸 */
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 头部区域 -->
    <header class="bg-white shadow-sm py-3 px-4 md:px-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800" id="header-title">四则运算练习</h1>
        <div class="flex items-center gap-3">
            <button id="fullscreen-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors" title="全屏">
                <i class="fa fa-expand text-gray-600"></i>
            </button>
            <button id="lang-toggle" class="px-3 py-1 rounded bg-primary text-white hover:bg-primary/90 transition-colors">
                EN
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 md:py-8 max-w-5xl">
        <!-- 题目生成设置区域 -->
        <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4" id="settings-title">题目生成设置</h2>
            
            <div class="space-y-4">
                <!-- 题目数量 -->
                <div class="flex items-center">
                    <label for="num-questions" class="w-28 md:w-36 text-gray-700" id="label-questions">题目数量:</label>
                    <input type="number" id="num-questions" min="1" max="50" value="5" 
                        class="border border-gray-300 rounded-md px-3 py-2 w-20 focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                
                <!-- 运算符号 -->
                <div class="flex items-center flex-wrap">
                    <label class="w-28 md:w-36 text-gray-700" id="label-operators">运算符号:</label>
                    <div class="flex gap-3 md:gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="operators" value="+" checked 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1">+</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="operators" value="-" 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1">-</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="operators" value="×" 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1">×</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="operators" value="÷" 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1">÷</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="operators" value="()" 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1" id="label-brackets">括号</span>
                        </label>
                    </div>
                </div>
                
                <!-- 数字数量 -->
                <div class="flex items-center">
                    <label for="num-numbers" class="w-28 md:w-36 text-gray-700" id="label-num-numbers">数字数量:</label>
                    <input type="number" id="num-numbers" min="2" max="5" value="2" 
                        class="border border-gray-300 rounded-md px-3 py-2 w-20 focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                
                <!-- 数字位数 -->
                <div class="flex items-center">
                    <label for="digit-length" class="w-28 md:w-36 text-gray-700" id="label-digit-length">数字位数:</label>
                    <input type="number" id="digit-length" min="1" max="3" value="2" 
                        class="border border-gray-300 rounded-md px-3 py-2 w-20 focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                
                <!-- 答案位置 -->
                <div class="flex items-center">
                    <label class="w-28 md:w-36 text-gray-700" id="label-answer-position">答案位置:</label>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="answer-position" value="left" 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1" id="label-left">左</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="answer-position" value="right" checked
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1" id="label-right">右</span>
                        </label>
                    </div>
                </div>
                
                <!-- 数字类型 -->
                <div class="flex items-center">
                    <label class="w-28 md:w-36 text-gray-700" id="label-number-type">数字类型:</label>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="number-type" value="integer" checked
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1" id="label-integer">整数</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="number-type" value="decimal" 
                                class="form-checkbox h-4 w-4 text-primary rounded">
                            <span class="ml-1" id="label-decimal">小数</span>
                        </label>
                    </div>
                </div>
                
                <!-- 生成题目按钮 -->
                <div class="pt-2">
                    <button id="generate-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-md transition-colors flex items-center gap-2">
                        <i class="fa fa-refresh"></i>
                        <span id="btn-generate">生成题目</span>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- 练习题区域 -->
        <section class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-16">
            <h2 class="text-xl font-semibold text-gray-800 mb-4" id="exercises-title">练习题</h2>
            <div id="questions-container" class="space-y-2 min-h-[100px]">
                <!-- 题目将在这里动态生成 -->
                <div class="text-gray-500 italic" id="no-questions-message">点击上方"生成题目"按钮开始练习</div>
            </div>
        </section>
    </main>
    
    <!-- 悬浮按钮 -->
    <div class="fixed right-4 bottom-4 flex flex-col gap-3 z-40">
        <button id="show-answers-btn" class="bg-secondary hover:bg-secondary/90 text-white p-3 rounded-full shadow-lg transition-all hover:scale-105" title="显示答案">
            <i class="fa fa-check-circle"></i>
        </button>
        <button id="notepad-btn" class="bg-primary hover:bg-primary/90 text-white p-3 rounded-full shadow-lg transition-all hover:scale-105" title="草稿纸">
            <i class="fa fa-pencil"></i>
        </button>
    </div>
    
    <!-- 草稿纸 -->
    <div id="notepad" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div id="notepad-container" class="bg-white rounded-lg shadow-2xl flex flex-col max-w-[95vw] w-[500px] h-[80vh] overflow-hidden">
            <!-- 草稿纸标题栏 -->
            <div id="notepad-header" class="bg-gray-100 p-3 flex items-center justify-between cursor-move border-b">
                <div class="flex items-center">
                    <div id="resize-handle" class="w-4 h-4 bg-gray-400 rounded-sm cursor-nwse-resize mr-2"></div>
                    <span id="notepad-title" class="font-medium">草稿纸</span>
                </div>
                <div class="flex gap-1">
                    <!-- 撤销和重做按钮 - 增大移动端点击区域 -->
                    <button id="undo-btn" class="notepad-btn notepad-btn-mobile" title="撤销">
                        <i class="fa fa-undo"></i>
                    </button>
                    <button id="redo-btn" class="notepad-btn notepad-btn-mobile" title="重做">
                        <i class="fa fa-repeat"></i>
                    </button>
                    <button id="clear-notepad-btn" class="notepad-btn notepad-btn-mobile" title="清空">
                        <i class="fa fa-trash"></i>
                    </button>
                    <button id="close-notepad-btn" class="notepad-btn notepad-btn-mobile" title="关闭">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- 草稿纸画布 -->
            <div id="notepad-content" class="flex-1 overflow-hidden bg-paper relative">
                <canvas id="drawing-canvas" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <script>
        // 全局状态变量
        const state = {
            language: 'zh', // 默认中文
            equations: [], // 存储生成的题目和答案
            currentPenColor: '#000000', // 默认画笔颜色
            currentPenSize: 3, // 默认画笔大小
            currentBgColor: '#FFFDD0', // 默认背景颜色
            isDrawing: false, // 是否正在绘画
            lastX: 0, // 上一个X坐标
            lastY: 0, // 上一个Y坐标
            // 用于撤销重做的历史记录
            history: [],
            historyIndex: -1,
            // 记录当前绘制的路径
            currentPath: [],
            // 防止重复保存的标志
            isSavingState: false
        };

        // DOM元素引用
        const elements = {
            // 头部元素
            headerTitle: document.getElementById('header-title'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            langToggle: document.getElementById('lang-toggle'),
            
            // 设置区域元素
            settingsTitle: document.getElementById('settings-title'),
            numQuestions: document.getElementById('num-questions'),
            operators: document.querySelectorAll('input[name="operators"]'),
            numNumbers: document.getElementById('num-numbers'),
            digitLength: document.getElementById('digit-length'),
            answerPositions: document.querySelectorAll('input[name="answer-position"]'),
            numberTypes: document.querySelectorAll('input[name="number-type"]'),
            generateBtn: document.getElementById('generate-btn'),
            
            // 练习题区域元素
            exercisesTitle: document.getElementById('exercises-title'),
            questionsContainer: document.getElementById('questions-container'),
            noQuestionsMessage: document.getElementById('no-questions-message'),
            
            // 悬浮按钮
            showAnswersBtn: document.getElementById('show-answers-btn'),
            notepadBtn: document.getElementById('notepad-btn'),
            
            // 草稿纸元素
            notepad: document.getElementById('notepad'),
            notepadContainer: document.getElementById('notepad-container'),
            notepadHeader: document.getElementById('notepad-header'),
            resizeHandle: document.getElementById('resize-handle'),
            clearNotepadBtn: document.getElementById('clear-notepad-btn'),
            closeNotepadBtn: document.getElementById('close-notepad-btn'),
            notepadTitle: document.getElementById('notepad-title'),
            drawingCanvas: document.getElementById('drawing-canvas'),
            notepadContent: document.getElementById('notepad-content'),
            // 撤销和重做按钮
            undoBtn: document.getElementById('undo-btn'),
            redoBtn: document.getElementById('redo-btn'),
            
            // 标签元素
            labelQuestions: document.getElementById('label-questions'),
            labelOperators: document.getElementById('label-operators'),
            labelBrackets: document.getElementById('label-brackets'),
            labelNumNumbers: document.getElementById('label-num-numbers'),
            labelDigitLength: document.getElementById('label-digit-length'),
            labelAnswerPosition: document.getElementById('label-answer-position'),
            labelLeft: document.getElementById('label-left'),
            labelRight: document.getElementById('label-right'),
            labelNumberType: document.getElementById('label-number-type'),
            labelInteger: document.getElementById('label-integer'),
            labelDecimal: document.getElementById('label-decimal'),
            btnGenerate: document.getElementById('btn-generate'),
        };

        // 翻译文本映射
        const translations = {
            zh: {
                headerTitle: '四则运算练习',
                settingsTitle: '题目生成设置',
                labelQuestions: '题目数量:',
                labelOperators: '运算符号:',
                labelBrackets: '括号',
                labelNumNumbers: '数字数量:',
                labelDigitLength: '数字位数:',
                labelAnswerPosition: '答案位置:',
                labelLeft: '左',
                labelRight: '右',
                labelNumberType: '数字类型:',
                labelInteger: '整数',
                labelDecimal: '小数',
                btnGenerate: '生成题目',
                exercisesTitle: '练习题',
                noQuestionsMessage: '点击上方"生成题目"按钮开始练习',
                notepadTitle: '草稿纸'
            },
            en: {
                headerTitle: 'Arithmetic Practice',
                settingsTitle: 'Question Settings',
                labelQuestions: 'Number of questions:',
                labelOperators: 'Operators:',
                labelBrackets: 'Brackets',
                labelNumNumbers: 'Number count:',
                labelDigitLength: 'Digit length:',
                labelAnswerPosition: 'Answer position:',
                labelLeft: 'Left',
                labelRight: 'Right',
                labelNumberType: 'Number type:',
                labelInteger: 'Integer',
                labelDecimal: 'Decimal',
                btnGenerate: 'Generate Questions',
                exercisesTitle: 'Practice Questions',
                noQuestionsMessage: 'Click "Generate Questions" above to start',
                notepadTitle: 'Notepad'
            }
        };

        // 初始化函数
        function init() {
            // 设置事件监听器
            setupEventListeners();
            
            // 初始化画布
            initCanvas();
            
            // 初始化历史记录
            saveState();
        }

        // 移除所有输入元素的焦点
        function blurAllInputs() {
            // 模糊所有输入框
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.blur();
            });
            
            // 在移动端，创建一个临时输入框并立即模糊它，强制隐藏键盘
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                const tempInput = document.createElement('input');
                tempInput.style.position = 'absolute';
                tempInput.style.opacity = '0';
                tempInput.style.pointerEvents = 'none';
                document.body.appendChild(tempInput);
                tempInput.focus();
                tempInput.blur();
                document.body.removeChild(tempInput);
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 全屏按钮
            elements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            elements.fullscreenBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                toggleFullscreen();
            });
            
            // 语言切换按钮
            elements.langToggle.addEventListener('click', toggleLanguage);
            elements.langToggle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                toggleLanguage();
            });
            
            // 生成题目按钮
            elements.generateBtn.addEventListener('click', generateQuestions);
            elements.generateBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                generateQuestions();
            });
            
            // 显示答案按钮
            elements.showAnswersBtn.addEventListener('click', showAnswers);
            elements.showAnswersBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                showAnswers();
            });
            
            // 草稿纸按钮 - 点击时移除所有输入框焦点
            elements.notepadBtn.addEventListener('click', () => {
                blurAllInputs();
                toggleNotepad();
            });
            elements.notepadBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                blurAllInputs();
                toggleNotepad();
            });
            
            // 关闭草稿纸按钮 - 点击时移除所有输入框焦点
            elements.closeNotepadBtn.addEventListener('click', () => {
                toggleNotepad();
            });
            elements.closeNotepadBtn.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                e.preventDefault();
                toggleNotepad();
            });
            
            // 清空草稿纸按钮
            elements.clearNotepadBtn.addEventListener('click', clearCanvas);
            elements.clearNotepadBtn.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                e.preventDefault();
                clearCanvas();
            });
            
            // 撤销和重做按钮事件
            elements.undoBtn.addEventListener('click', undo);
            elements.undoBtn.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                e.preventDefault();
                undo();
            });
            
            elements.redoBtn.addEventListener('click', redo);
            elements.redoBtn.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                e.preventDefault();
                redo();
            });
            
            // 为草稿纸背景添加点击事件，点击时移除焦点
            elements.notepad.addEventListener('click', (e) => {
                // 如果点击的是背景遮罩，移除所有焦点
                if (e.target === elements.notepad) {
                    blurAllInputs();
                }
            });
            
            // 初始化拖拽功能
            initDragAndResize();
            
            // 初始化画布事件
            initCanvasEvents();
        }

        // 切换全屏
        function toggleFullscreen() {
            blurAllInputs(); // 全屏切换时移除焦点
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`无法进入全屏模式: ${err.message}`);
                });
                elements.fullscreenBtn.innerHTML = '<i class="fa fa-compress text-gray-600"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    elements.fullscreenBtn.innerHTML = '<i class="fa fa-expand text-gray-600"></i>';
                }
            }
        }

        // 切换语言
        function toggleLanguage() {
            blurAllInputs(); // 语言切换时移除焦点
            
            state.language = state.language === 'zh' ? 'en' : 'zh';
            elements.langToggle.textContent = state.language === 'zh' ? 'EN' : '中';
            updateTranslations();
        }

        // 更新翻译
        function updateTranslations() {
            const lang = state.language;
            elements.headerTitle.textContent = translations[lang].headerTitle;
            elements.settingsTitle.textContent = translations[lang].settingsTitle;
            elements.labelQuestions.textContent = translations[lang].labelQuestions;
            elements.labelOperators.textContent = translations[lang].labelOperators;
            elements.labelBrackets.textContent = translations[lang].labelBrackets;
            elements.labelNumNumbers.textContent = translations[lang].labelNumNumbers;
            elements.labelDigitLength.textContent = translations[lang].labelDigitLength;
            elements.labelAnswerPosition.textContent = translations[lang].labelAnswerPosition;
            elements.labelLeft.textContent = translations[lang].labelLeft;
            elements.labelRight.textContent = translations[lang].labelRight;
            elements.labelNumberType.textContent = translations[lang].labelNumberType;
            elements.labelInteger.textContent = translations[lang].labelInteger;
            elements.labelDecimal.textContent = translations[lang].labelDecimal;
            elements.btnGenerate.textContent = translations[lang].btnGenerate;
            elements.exercisesTitle.textContent = translations[lang].exercisesTitle;
            elements.noQuestionsMessage.textContent = translations[lang].noQuestionsMessage;
            elements.notepadTitle.textContent = translations[lang].notepadTitle;
        }

        // 生成随机数
        function generateRandomNumber(digitLength, isDecimal) {
            const min = 10 **(digitLength - 1);
            const max = (10** digitLength) - 1;
            
            let number = Math.random() * (max - min) + min;
            
            // 如果是小数，保留1-2位小数
            if (isDecimal) {
                number = Number(number.toFixed(Math.floor(Math.random() * 2) + 1));
            } else {
                number = Math.floor(number);
            }
            
            // 确保不会出现0
            return number === 0 ? 1 : number;
        }

        // 获取选中的运算符
        function getSelectedOperators() {
            const selected = [];
            elements.operators.forEach(op => {
                if (op.checked) {
                    selected.push(op.value);
                }
            });
            return selected;
        }

        // 获取选中的答案位置
        function getSelectedAnswerPositions() {
            const selected = [];
            elements.answerPositions.forEach(pos => {
                if (pos.checked) {
                    selected.push(pos.value);
                }
            });
            return selected.length > 0 ? selected : ['right']; // 默认右侧
        }

        // 获取选中的数字类型
        function getSelectedNumberTypes() {
            const selected = [];
            elements.numberTypes.forEach(type => {
                if (type.checked) {
                    selected.push(type.value);
                }
            });
            return selected.length > 0 ? selected : ['integer']; // 默认整数
        }

        // 生成带括号的表达式
        function generateExpressionWithBrackets(numbers, ops) {
            // 确保有足够的数字来添加有意义的括号
            if (numbers.length < 3) {
                // 数字太少，无法形成有意义的括号表达式
                let expr = '';
                for (let i = 0; i < numbers.length; i++) {
                    expr += numbers[i];
                    if (i < ops.length) {
                        expr += ops[i];
                    }
                }
                return expr;
            }
            
            // 选择括号的起始和结束位置，确保至少包含两个数字和一个运算符
            const minLength = 2; // 至少包含两个数字和一个运算符
            const maxStart = numbers.length - minLength - 1;
            const start = Math.floor(Math.random() * (maxStart + 1));
            const maxEnd = numbers.length - 1;
            const end = Math.floor(Math.random() * (maxEnd - (start + minLength) + 1)) + start + minLength;
            
            // 构建带括号的表达式
            let expr = '';
            for (let i = 0; i < numbers.length; i++) {
                // 在起始位置添加左括号
                if (i === start) {
                    expr += '(';
                }
                
                expr += numbers[i];
                
                // 在结束位置添加右括号
                if (i === end) {
                    expr += ')';
                }
                
                // 添加运算符（如果不是最后一个数字）
                if (i < ops.length) {
                    expr += ops[i];
                }
            }
            
            return expr;
        }

        // ------------ 表达式解析和计算系统 ------------

        // 运算符优先级
        const OPERATOR_PRECEDENCE = {
            '+': 1,
            '-': 1,
            '×': 2,
            '÷': 2
        };

        // 将中缀表达式转换为后缀表达式(逆波兰表示法)
        function infixToPostfix(expression) {
            const outputQueue = [];
            const operatorStack = [];
            let currentNumber = '';
            let isDecimal = false;
            
            // 处理表达式中的每个字符
            for (let i = 0; i < expression.length; i++) {
                const char = expression[i];
                
                // 如果是数字或小数点，构建当前数字
                if (!isNaN(parseFloat(char)) || (char === '.' && !isDecimal)) {
                    currentNumber += char;
                    if (char === '.') isDecimal = true;
                } else {
                    // 如果正在构建数字，将其添加到输出队列
                    if (currentNumber !== '') {
                        outputQueue.push(parseFloat(currentNumber));
                        currentNumber = '';
                        isDecimal = false;
                    }
                    
                    // 处理运算符和括号
                    if (char === '(') {
                        operatorStack.push(char);
                    } else if (char === ')') {
                        // 弹出直到遇到左括号
                        while (operatorStack.length > 0 && operatorStack[operatorStack.length - 1] !== '(') {
                            outputQueue.push(operatorStack.pop());
                        }
                        operatorStack.pop(); // 弹出左括号，不添加到输出队列
                    } else if (OPERATOR_PRECEDENCE[char] !== undefined) {
                        // 处理运算符，按照优先级弹出
                        while (operatorStack.length > 0 && 
                               operatorStack[operatorStack.length - 1] !== '(' && 
                               OPERATOR_PRECEDENCE[operatorStack[operatorStack.length - 1]] >= OPERATOR_PRECEDENCE[char]) {
                            outputQueue.push(operatorStack.pop());
                        }
                        operatorStack.push(char);
                    }
                }
            }
            
            // 添加最后一个数字
            if (currentNumber !== '') {
                outputQueue.push(parseFloat(currentNumber));
            }
            
            // 弹出所有剩余的运算符
            while (operatorStack.length > 0) {
                outputQueue.push(operatorStack.pop());
            }
            
            return outputQueue;
        }

        // 计算后缀表达式
        function calculatePostfix(postfix) {
            const stack = [];
            
            for (const token of postfix) {
                // 如果是数字，压入栈
                if (typeof token === 'number') {
                    stack.push(token);
                } else {
                    // 如果是运算符，弹出两个数字进行计算
                    if (stack.length < 2) {
                        console.error('无效的表达式');
                        return null;
                    }
                    
                    const b = stack.pop();
                    const a = stack.pop();
                    let result;
                    
                    switch (token) {
                        case '+':
                            result = a + b;
                            break;
                        case '-':
                            result = a - b;
                            break;
                        case '×':
                            result = a * b;
                            break;
                        case '÷':
                            if (b === 0) {
                                console.error('除数不能为零');
                                return null;
                            }
                            result = a / b;
                            break;
                        default:
                            console.error('未知运算符:', token);
                            return null;
                    }
                    
                    stack.push(result);
                }
            }
            
            // 栈中应该只剩下一个结果
            if (stack.length !== 1) {
                console.error('表达式计算错误');
                return null;
            }
            
            return stack[0];
        }

        // 计算表达式的主函数
        function calculateExpression(expression) {
            try {
                // 转换为后缀表达式
                const postfix = infixToPostfix(expression);
                if (!postfix || postfix.length === 0) {
                    console.error('无法解析表达式:', expression);
                    return null;
                }
                
                // 计算后缀表达式
                let result = calculatePostfix(postfix);
                if (result === null) {
                    console.error('表达式计算失败:', expression);
                    return null;
                }
                
                // 处理浮点数精度问题
                if (Math.abs(result) > 0.000001 && Math.abs(result - Math.round(result)) < 0.000001) {
                    result = Math.round(result);
                } else {
                    // 保留6位小数，避免过多小数位
                    result = Number(result.toFixed(6));
                }
                
                return result;
            } catch (e) {
                console.error('计算表达式错误:', e, '表达式:', expression);
                return null;
            }
        }

        // 生成表达式字符串和答案位置信息 - 重点修复左侧答案位置
        function generateExpressionWithAnswerPosition(numNumbers, operators, digitLength, numberTypes, useBrackets, answerPosition) {
            // 对于左侧答案位置，我们需要特殊处理以确保答案正确
            if (answerPosition === 'left') {
                // 确保至少有2个数字
                if (numNumbers < 2) numNumbers = 2;
                
                // 生成除了第一个数字外的其他数字
                const otherNumbers = [];
                for (let i = 0; i < numNumbers - 1; i++) {
                    const isDecimal = numberTypes.includes('decimal') && 
                                     (numberTypes.length === 1 || Math.random() > 0.5);
                    otherNumbers.push(generateRandomNumber(digitLength, isDecimal));
                }
                
                // 生成运算符
                const ops = [];
                for (let i = 0; i < numNumbers - 2; i++) { // 少一个运算符
                    const opIndex = Math.floor(Math.random() * operators.length);
                    let op = operators[opIndex];
                    
                    // 特殊处理除法避免除零
                    if (op === '÷' && otherNumbers[i + 1] === 0) {
                        // 更换为乘法
                        op = '×';
                    }
                    
                    ops.push(op);
                }
                
                // 生成第一个运算符（连接未知数字和第一个已知数字）
                let firstOp;
                do {
                    const opIndex = Math.floor(Math.random() * operators.length);
                    firstOp = operators[opIndex];
                } while (firstOp === '÷'); // 避免第一个运算符为除法，使计算更直观
                
                // 构建右侧表达式（不含第一个数字）
                let rightExpression = '';
                for (let i = 0; i < otherNumbers.length; i++) {
                    rightExpression += otherNumbers[i];
                    if (i < ops.length) {
                        rightExpression += ops[i];
                    }
                }
                
                // 计算右侧表达式的结果
                const rightResult = calculateExpression(rightExpression);
                if (rightResult === null) return null;
                
                // 生成最终结果（将作为等号右边的值）
                const finalResult = generateRandomNumber(digitLength, 
                    numberTypes.includes('decimal') && (numberTypes.length === 1 || Math.random() > 0.5));
                
                // 根据第一个运算符计算左侧未知数（答案）
                let leftNumber; // 这将是左侧的答案
                switch (firstOp) {
                    case '+':
                        leftNumber = finalResult - rightResult;
                        break;
                    case '-':
                        leftNumber = finalResult + rightResult;
                        break;
                    case '×':
                        // 确保不会除以零
                        if (rightResult === 0) return null;
                        leftNumber = finalResult / rightResult;
                        break;
                    default: // 默认为加法
                        leftNumber = finalResult - rightResult;
                        firstOp = '+';
                }
                
                // 确保左侧数字是有效数字
                if (isNaN(leftNumber) || !isFinite(leftNumber)) return null;
                
                // 格式化左侧数字
                leftNumber = Number(leftNumber.toFixed(6));
                
                // 构建完整表达式用于验证
                const fullExpression = `${leftNumber}${firstOp}${rightExpression}`;
                const fullExpressionResult = calculateExpression(fullExpression);
                
                // 验证完整表达式结果是否与我们预期的finalResult一致
                if (fullExpressionResult === null || Math.abs(fullExpressionResult - finalResult) > 0.001) {
                    return null;
                }
                
                // 构建显示表达式（不含左侧数字）
                const displayExpression = `${firstOp}${rightExpression}`;
                
                return {
                    originalExpression: fullExpression,
                    displayExpression: displayExpression,
                    result: leftNumber, // 左侧的答案
                    fullResult: finalResult // 等号右侧的结果
                };
            } else {
                // 右侧答案位置：正常表达式，结果为答案
                // 生成数字
                const numbers = [];
                for (let i = 0; i < numNumbers; i++) {
                    const isDecimal = numberTypes.includes('decimal') && 
                                     (numberTypes.length === 1 || Math.random() > 0.5);
                    numbers.push(generateRandomNumber(digitLength, isDecimal));
                }
                
                // 生成运算符
                const ops = [];
                for (let i = 0; i < numNumbers - 1; i++) {
                    // 对于减法和除法，确保结果不会为负数或导致除零错误
                    let op;
                    let valid = false;
                    
                    while (!valid) {
                        const opIndex = Math.floor(Math.random() * operators.length);
                        op = operators[opIndex];
                        
                        // 特殊处理减法和除法
                        if (op === '-' || op === '÷') {
                            const num1 = numbers[i];
                            const num2 = numbers[i + 1];
                            
                            // 减法确保结果非负，除法确保被除数大于除数且除数不为0
                            if ((op === '-' && num1 < num2) || 
                                (op === '÷' && (num1 < num2 || num2 === 0))) {
                                // 交换数字位置使运算结果有效
                                [numbers[i], numbers[i + 1]] = [numbers[i + 1], numbers[i]];
                            }
                            
                            // 再次检查除法是否有效
                            if (op === '÷' && numbers[i + 1] === 0) {
                                valid = false;
                            } else {
                                valid = true;
                            }
                        } else {
                            valid = true;
                        }
                    }
                    
                    ops.push(op);
                }
                
                // 构建基础表达式或带括号的表达式
                let expressionWithBrackets;
                if (useBrackets && Math.random() > 0.5) {
                    expressionWithBrackets = generateExpressionWithBrackets(numbers, ops);
                } else {
                    // 构建基础表达式
                    expressionWithBrackets = '';
                    for (let i = 0; i < numbers.length; i++) {
                        expressionWithBrackets += numbers[i];
                        if (i < ops.length) {
                            expressionWithBrackets += ops[i];
                        }
                    }
                }
                
                // 计算完整表达式的结果
                const fullResult = calculateExpression(expressionWithBrackets);
                
                // 验证计算结果
                if (fullResult === null || isNaN(fullResult) || !isFinite(fullResult)) {
                    return null;
                }
                
                return {
                    originalExpression: expressionWithBrackets,
                    displayExpression: expressionWithBrackets,
                    result: fullResult,
                    fullResult: fullResult
                };
            }
        }

        // 生成题目
        function generateQuestions() {
            blurAllInputs(); // 生成题目时移除焦点
            
            const numQuestions = parseInt(elements.numQuestions.value) || 5;
            const numNumbers = parseInt(elements.numNumbers.value) || 2;
            const digitLength = parseInt(elements.digitLength.value) || 2;
            const operators = getSelectedOperators();
            const answerPositions = getSelectedAnswerPositions();
            const numberTypes = getSelectedNumberTypes();
            const useBrackets = operators.includes('()');
            
            // 确保至少选择了一个运算符（不包括括号）
            const hasValidOperator = operators.some(op => op !== '()');
            if (!hasValidOperator) {
                alert('请至少选择一个运算符（+、-、×、÷）');
                return;
            }
            
            // 过滤掉括号，只保留实际运算符
            const validOperators = operators.filter(op => op !== '()');
            
            // 清空之前的题目
            elements.questionsContainer.innerHTML = '';
            state.equations = [];
            
            for (let i = 0; i < numQuestions; i++) {
                // 随机选择答案位置
                const answerPosition = answerPositions[Math.floor(Math.random() * answerPositions.length)];
                
                // 生成表达式和答案信息，确保计算结果有效
                let exprData = null;
                let attempts = 0;
                const maxAttempts = 30; // 最多尝试30次生成有效表达式
                
                while (!exprData && attempts < maxAttempts) {
                    const tempData = generateExpressionWithAnswerPosition(
                        numNumbers, validOperators, digitLength, numberTypes, useBrackets, answerPosition
                    );
                    
                    // 验证结果是否有效
                    if (tempData && tempData.fullResult !== null && !isNaN(tempData.fullResult) && isFinite(tempData.fullResult)) {
                        exprData = tempData;
                    }
                    
                    attempts++;
                }
                
                // 如果多次尝试后仍无法生成有效表达式，显示错误
                if (!exprData) {
                    console.error("无法生成有效的表达式，请尝试调整设置");
                    alert("无法生成有效的表达式，请尝试调整设置");
                    return;
                }
                
                // 创建题目元素
                const equationElement = document.createElement('div');
                equationElement.className = 'equation-container';
                equationElement.dataset.index = i;
                
                // 构建题目HTML
                let equationHtml = '';
                
                if (answerPosition === 'right') {
                    // 答案在右侧：表达式 = [输入框]
                    equationHtml = `${exprData.displayExpression} = <input type="number" step="any" class="equation-input" data-index="${i}">`;
                } else {
                    // 答案在左侧：[输入框] 表达式 = 结果
                    equationHtml = `<input type="number" step="any" class="equation-input" data-index="${i}"> ${exprData.displayExpression} = ${formatNumber(exprData.fullResult)}`;
                }
                
                equationElement.innerHTML = equationHtml + '<span class="result-icon"></span>';
                elements.questionsContainer.appendChild(equationElement);
                
                // 存储题目和答案
                state.equations.push({
                    originalExpression: exprData.originalExpression,
                    displayExpression: exprData.displayExpression,
                    result: exprData.result,  // 正确答案
                    fullResult: exprData.fullResult,  // 完整表达式的结果
                    answerPosition
                });
            }
        }

        // 显示答案
        function showAnswers() {
            blurAllInputs(); // 显示答案时移除焦点
            
            if (state.equations.length === 0) return;
            
            const inputs = document.querySelectorAll('.equation-input');
            inputs.forEach((input, index) => {
                const equation = state.equations[index];
                const userAnswer = parseFloat(input.value);
                const correctAnswer = equation.result;
                const resultIcon = input.parentElement.querySelector('.result-icon');
                
                // 检查答案
                if (isNaN(userAnswer)) {
                    // 未填写答案，显示正确答案
                    resultIcon.textContent = formatNumber(correctAnswer);
                    resultIcon.className = 'result-icon text-gray-600';
                } else {
                    // 检查答案是否正确（考虑浮点数精度）
                    const isCorrect = Math.abs(userAnswer - correctAnswer) < 0.001;
                    
                    if (isCorrect) {
                        resultIcon.innerHTML = '✔';
                        resultIcon.className = 'result-icon text-success';
                    } else {
                        resultIcon.innerHTML = `✘ ${formatNumber(correctAnswer)}`;
                        resultIcon.className = 'result-icon text-error';
                    }
                }
            });
        }

        // 格式化数字（移除不必要的.0）
        function formatNumber(num) {
            // 处理整数显示
            if (Number.isInteger(num)) {
                return num.toString();
            }
            
            // 处理小数，最多显示4位小数
            const fixed = num.toFixed(4);
            // 移除末尾的0和可能的小数点
            return fixed.replace(/\.?0+$/, '');
        }

        // 切换草稿纸显示/隐藏
        function toggleNotepad() {
            elements.notepad.classList.toggle('hidden');
            elements.notepad.classList.toggle('flex');
            
            // 如果显示草稿纸，调整画布大小
            if (!elements.notepad.classList.contains('hidden')) {
                resizeCanvas();
                // 给草稿纸容器设置焦点，防止其他元素获取焦点
                elements.notepadContainer.setAttribute('tabindex', '-1');
                elements.notepadContainer.focus();
            } else {
                elements.notepadContainer.removeAttribute('tabindex');
            }
        }

        // 初始化画布
        function initCanvas() {
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            
            // 设置初始尺寸
            resizeCanvas();
            
            // 设置初始背景
            elements.notepadContent.style.backgroundColor = state.currentBgColor;
            
            // 设置初始画笔属性
            ctx.strokeStyle = state.currentPenColor;
            ctx.lineWidth = state.currentPenSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // 调整画布大小
        function resizeCanvas() {
            const canvas = elements.drawingCanvas;
            const container = elements.notepadContent;
            
            // 保存当前画布内容
            const data = canvas.toDataURL();
            
            // 设置画布尺寸以匹配显示尺寸
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // 恢复画布内容
            if (data && data !== "data:,") {
                const img = new Image();
                img.onload = function() {
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                };
                img.src = data;
            }
        }

        // 初始化画布事件
        function initCanvasEvents() {
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            
            // 鼠标/触摸开始事件
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('touchstart', (e) => {
                // 检查是否触摸在按钮上，如果是则不处理
                const touch = e.touches[0];
                const buttons = elements.notepadHeader.querySelectorAll('button');
                const isTouchOnButton = Array.from(buttons).some(button => {
                    const rect = button.getBoundingClientRect();
                    return touch.clientX >= rect.left && touch.clientX <= rect.right &&
                           touch.clientY >= rect.top && touch.clientY <= rect.bottom;
                });
                
                if (!isTouchOnButton) {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    startDrawing({
                        offsetX: touch.clientX - rect.left,
                        offsetY: touch.clientY - rect.top
                    });
                }
            });
            
            // 鼠标/触摸移动事件
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('touchmove', (e) => {
                if (state.isDrawing) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    draw({
                        offsetX: touch.clientX - rect.left,
                        offsetY: touch.clientY - rect.top
                    });
                }
            });
            
            // 鼠标/触摸结束事件
            window.addEventListener('mouseup', stopDrawing);
            window.addEventListener('touchend', (e) => {
                // 只有在正在绘制时才处理
                if (state.isDrawing) {
                    e.preventDefault();
                    stopDrawing();
                }
            });
            canvas.addEventListener('mouseleave', stopDrawing);
            
            // 窗口大小变化时调整画布
            window.addEventListener('resize', () => {
                if (!elements.notepad.classList.contains('hidden')) {
                    resizeCanvas();
                }
            });
        }

        // 开始绘画
        function startDrawing(e) {
            state.isDrawing = true;
            [state.lastX, state.lastY] = [e.offsetX, e.offsetY];
            
            // 开始记录新路径
            state.currentPath = [{
                x: state.lastX,
                y: state.lastY,
                type: 'start',
                color: state.currentPenColor,
                size: state.currentPenSize
            }];
        }

        // 绘画中
        function draw(e) {
            if (!state.isDrawing) return;
            
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            
            ctx.beginPath();
            ctx.moveTo(state.lastX, state.lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            
            // 设置当前绘画样式
            ctx.strokeStyle = state.currentPenColor;
            ctx.lineWidth = state.currentPenSize;
            
            ctx.stroke();
            
            // 记录绘制路径
            state.currentPath.push({
                x: e.offsetX,
                y: e.offsetY,
                type: 'line',
                color: state.currentPenColor,
                size: state.currentPenSize
            });
            
            [state.lastX, state.lastY] = [e.offsetX, e.offsetY];
        }

        // 停止绘画
        function stopDrawing() {
            if (state.isDrawing && state.currentPath.length > 1) {
                state.isDrawing = false;
                // 保存当前路径到历史记录
                saveState();
            }
        }

        // 清空画布
        function clearCanvas() {
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // 保存清空状态到历史记录
            saveState();
        }

        // 保存当前状态到历史记录
        function saveState() {
            // 防止重复保存
            if (state.isSavingState) return;
            state.isSavingState = true;
            
            setTimeout(() => {
                try {
                    const canvas = elements.drawingCanvas;
                    
                    // 如果处于历史记录中间位置，清除后面的记录
                    if (state.historyIndex < state.history.length - 1) {
                        state.history = state.history.slice(0, state.historyIndex + 1);
                    }
                    
                    // 保存当前画布状态
                    const data = canvas.toDataURL();
                    
                    // 避免保存重复状态
                    if (state.history.length === 0 || state.history[state.historyIndex] !== data) {
                        state.history.push(data);
                        
                        // 限制历史记录数量，防止内存占用过大
                        const maxHistory = 50;
                        if (state.history.length > maxHistory) {
                            state.history.shift();
                        }
                        
                        // 更新历史记录索引
                        state.historyIndex = state.history.length - 1;
                        
                        // 更新按钮状态
                        updateHistoryButtons();
                    }
                } catch (error) {
                    console.error("保存历史记录失败:", error);
                } finally {
                    state.isSavingState = false;
                }
            }, 100); // 短暂延迟防止快速连续保存
        }

        // 撤销操作
        function undo() {
            if (state.historyIndex > 0) {
                state.historyIndex--;
                restoreState();
            }
        }

        // 重做操作
        function redo() {
            if (state.historyIndex < state.history.length - 1) {
                state.historyIndex++;
                restoreState();
            }
        }

        // 恢复指定状态
        function restoreState() {
            const canvas = elements.drawingCanvas;
            const ctx = canvas.getContext('2d');
            
            // 清除当前画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 检查历史记录是否有效
            if (state.historyIndex >= 0 && state.historyIndex < state.history.length) {
                const data = state.history[state.historyIndex];
                
                // 确保数据有效
                if (data && data !== "data:,") {
                    const img = new Image();
                    img.onload = function() {
                        // 绘制历史状态
                        ctx.drawImage(img, 0, 0);
                        // 更新按钮状态
                        updateHistoryButtons();
                    };
                    img.onerror = function() {
                        console.error("恢复历史记录失败，图片加载错误");
                        updateHistoryButtons();
                    };
                    img.src = data;
                } else {
                    updateHistoryButtons();
                }
            }
        }

        // 更新撤销/重做按钮状态
        function updateHistoryButtons() {
            // 撤销按钮状态
            if (state.historyIndex <= 0) {
                elements.undoBtn.classList.add('opacity-50', 'cursor-not-allowed');
                elements.undoBtn.classList.remove('hover:bg-gray-200');
            } else {
                elements.undoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                elements.undoBtn.classList.add('hover:bg-gray-200');
            }
            
            // 重做按钮状态
            if (state.historyIndex >= state.history.length - 1) {
                elements.redoBtn.classList.add('opacity-50', 'cursor-not-allowed');
                elements.redoBtn.classList.remove('hover:bg-gray-200');
            } else {
                elements.redoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                elements.redoBtn.classList.add('hover:bg-gray-200');
            }
        }

        // 初始化拖拽和调整大小功能
        function initDragAndResize() {
            let isDragging = false;
            let isResizing = false;
            let startX, startY;
            let startWidth, startHeight;
            let containerX, containerY;
            const minWidth = 200;
            const minHeight = 200;
            
            // 拖拽开始 - 仅在标题栏上（排除按钮区域）
            elements.notepadHeader.addEventListener('mousedown', (e) => {
                // 检查点击是否在标题栏的可拖拽区域（非按钮区）
                const isButtonArea = Array.from(elements.notepadHeader.querySelectorAll('button')).some(btn => 
                    btn.contains(e.target)
                );
                
                if (e.target === elements.resizeHandle || isButtonArea) {
                    return; // 调整大小时或点击按钮时不触发拖拽
                }
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                // 获取当前容器位置
                const rect = elements.notepadContainer.getBoundingClientRect();
                containerX = rect.left;
                containerY = rect.top;
                
                elements.notepadHeader.classList.add('dragging');
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'grabbing';
            });
            
            // 调整大小开始
            elements.resizeHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                
                // 获取当前容器尺寸和位置
                const rect = elements.notepadContainer.getBoundingClientRect();
                startWidth = rect.width;
                startHeight = rect.height;
                containerX = rect.left;
                containerY = rect.top;
                
                elements.resizeHandle.classList.add('resizing');
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'nwse-resize';
            });
            
            // 鼠标移动
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    // 计算新位置
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    // 应用新位置
                    const newX = containerX + dx;
                    const newY = containerY + dy;
                    
                    // 限制在可视区域内
                    const maxX = window.innerWidth - elements.notepadContainer.offsetWidth;
                    const maxY = window.innerHeight - elements.notepadContainer.offsetHeight;
                    
                    elements.notepadContainer.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
                    elements.notepadContainer.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
                    elements.notepadContainer.style.right = 'auto';
                    elements.notepadContainer.style.bottom = 'auto';
                    // 移除居中变换，避免干扰拖拽
                    elements.notepadContainer.style.transform = 'none';
                }
                
                if (isResizing) {
                    // 计算新尺寸（左上角手柄逻辑）
                    const dx = startX - e.clientX;
                    const dy = startY - e.clientY;
                    
                    // 计算新宽度和高度（确保不小于最小值）
                    let newWidth = startWidth + dx;
                    let newHeight = startHeight + dy;
                    newWidth = Math.max(minWidth, newWidth);
                    newHeight = Math.max(minHeight, newHeight);
                    
                    // 计算新位置（左上角手柄拖动时调整位置）
                    let newX = containerX - dx;
                    let newY = containerY - dy;
                    
                    // 限制最大宽度不超过95vw
                    const maxWidth = window.innerWidth * 0.95;
                    newWidth = Math.min(newWidth, maxWidth);
                    
                    // 确保容器不会超出屏幕左侧和顶部
                    newX = Math.max(0, newX);
                    newY = Math.max(0, newY);
                    
                    // 确保容器不会超出屏幕右侧和底部
                    const maxX = window.innerWidth - newWidth;
                    const maxY = window.innerHeight - newHeight;
                    newX = Math.min(newX, maxX);
                    newY = Math.min(newY, maxY);
                    
                    // 应用新尺寸和位置
                    elements.notepadContainer.style.width = `${newWidth}px`;
                    elements.notepadContainer.style.height = `${newHeight}px`;
                    elements.notepadContainer.style.left = `${newX}px`;
                    elements.notepadContainer.style.top = `${newY}px`;
                    elements.notepadContainer.style.right = 'auto';
                    elements.notepadContainer.style.bottom = 'auto';
                    elements.notepadContainer.style.transform = 'none';
                    
                    // 调整画布大小
                    resizeCanvas();
                }
            });
            
            // 鼠标释放
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    elements.notepadHeader.classList.remove('dragging');
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
                
                if (isResizing) {
                    isResizing = false;
                    elements.resizeHandle.classList.remove('resizing');
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
            });
            
            // 触摸设备支持
            let touchIdentifier = null;
            
            // 触摸开始 - 拖拽
            elements.notepadHeader.addEventListener('touchstart', (e) => {
                // 检查是否触摸在按钮上
                const touch = e.touches[0];
                const buttons = elements.notepadHeader.querySelectorAll('button');
                const isTouchOnButton = Array.from(buttons).some(button => {
                    const rect = button.getBoundingClientRect();
                    return touch.clientX >= rect.left && touch.clientX <= rect.right &&
                           touch.clientY >= rect.top && touch.clientY <= rect.bottom;
                });
                
                if (e.target === elements.resizeHandle || isTouchOnButton) {
                    return; // 调整大小时或点击按钮时不触发拖拽
                }
                
                isDragging = true;
                touchIdentifier = touch.identifier;
                startX = touch.clientX;
                startY = touch.clientY;
                
                const rect = elements.notepadContainer.getBoundingClientRect();
                containerX = rect.left;
                containerY = rect.top;
                
                elements.notepadHeader.classList.add('dragging');
                document.body.style.userSelect = 'none';
            });
            
            // 调整大小触摸开始
            elements.resizeHandle.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                isResizing = true;
                const touch = e.touches[0];
                touchIdentifier = touch.identifier;
                startX = touch.clientX;
                startY = touch.clientY;
                
                const rect = elements.notepadContainer.getBoundingClientRect();
                startWidth = rect.width;
                startHeight = rect.height;
                containerX = rect.left;
                containerY = rect.top;
                
                elements.resizeHandle.classList.add('resizing');
                document.body.style.userSelect = 'none';
            });
            
            // 触摸移动
            document.addEventListener('touchmove', (e) => {
                if (!touchIdentifier) return;
                
                const touch = Array.from(e.touches).find(t => t.identifier === touchIdentifier);
                if (!touch) return;
                
                if (isDragging) {
                    const dx = touch.clientX - startX;
                    const dy = touch.clientY - startY;
                    
                    const newX = containerX + dx;
                    const newY = containerY + dy;
                    
                    const maxX = window.innerWidth - elements.notepadContainer.offsetWidth;
                    const maxY = window.innerHeight - elements.notepadContainer.offsetHeight;
                    
                    elements.notepadContainer.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
                    elements.notepadContainer.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
                    elements.notepadContainer.style.transform = 'none';
                    e.preventDefault();
                }
                
                if (isResizing) {
                    const dx = startX - touch.clientX;
                    const dy = startY - touch.clientY;
                    
                    let newWidth = startWidth + dx;
                    let newHeight = startHeight + dy;
                    newWidth = Math.max(minWidth, newWidth);
                    newHeight = Math.max(minHeight, newHeight);
                    
                    // 限制最大宽度
                    const maxWidth = window.innerWidth * 0.95;
                    newWidth = Math.min(newWidth, maxWidth);
                    
                    let newX = containerX - dx;
                    let newY = containerY - dy;
                    
                    // 边界检查
                    newX = Math.max(0, newX);
                    newY = Math.max(0, newY);
                    
                    const maxX = window.innerWidth - newWidth;
                    const maxY = window.innerHeight - newHeight;
                    newX = Math.min(newX, maxX);
                    newY = Math.min(newY, maxY);
                    
                    elements.notepadContainer.style.width = `${newWidth}px`;
                    elements.notepadContainer.style.height = `${newHeight}px`;
                    elements.notepadContainer.style.left = `${newX}px`;
                    elements.notepadContainer.style.top = `${newY}px`;
                    elements.notepadContainer.style.transform = 'none';
                    
                    resizeCanvas();
                    e.preventDefault();
                }
            });
            
            // 触摸结束
            document.addEventListener('touchend', (e) => {
                if (touchIdentifier && 
                    Array.from(e.changedTouches).some(t => t.identifier === touchIdentifier)) {
                    
                    if (isDragging) {
                        isDragging = false;
                        elements.notepadHeader.classList.remove('dragging');
                        document.body.style.userSelect = '';
                    }
                    
                    if (isResizing) {
                        isResizing = false;
                        elements.resizeHandle.classList.remove('resizing');
                        document.body.style.userSelect = '';
                    }
                    
                    touchIdentifier = null;
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
